#### 9 Kafka Broker工作流程

> 1. Kafka集群的每个broker启动之后都会向zookeeper进行注册
> 2. 注册完毕之后开始选择controller节点（争先抢占方式）
> 3. 选举出来的controller监听/brokers/ids/节点的变化
> 4.  监控完毕之后根据选举规则开始真正的选举Leader
> 5.  Controller将节点的Leader信息和isr信息写到zookeeper上
> 6.  其它的controller节点会冲zookeeper上拉取数据进行同步（防止controllerLeader挂了，随时上位）
> 7. 生产者往集群发送数据，发送数据之后Leader主动与Follower进行同步（底层通过LOG进行存储，实际为segment，分为.log文件和.index文件）再进行应答
> 8. 当Leader节点挂了之后controller监控到节点变化
> 9. Controller从zookeeper上拉取Leader信息和isr信息
> 10. Controller根据拉取的信息和选举规则再重新选举Leader
> 11.  选举出来新的Leader之后更新zookeeper中的信息

![](C:\study\mlog\picture\30.PNG)

![](C:\study\mlog\picture\31.PNG)

| 参数名称                                | 描述                                                         |
| --------------------------------------- | ------------------------------------------------------------ |
| replica.lag.time.max.ms                 | ISR中，如果Follower长时间未向Leader发送通信请求或同步数据，则该Follower将被踢出ISR,该时间阈值，默认30s |
| auto.leader.rebalance.enable            | 默认是true.自动Leader Partition平衡                          |
| leader.imbalance.per.broker.percentage  | 默认是 10%。每个broker 允许的不平衡的 leader的比率如果每个broker 超过了这个值，控制器会触发leader的平衡。 |
| leader.imbalance.check.interval.seconds | 默认值 300 秒。检查leader 负载是否平衡的间隔时间             |
| log.segment.bytes                       | Kafka 中log 日志是分成一块块存储的，此配置是指log 日志划分成块的大小，默认值 1G |
| log.index.interval.bytes                | 默认4kb，kafka 里面每当写入了 4kb 大小的日志 (log)，然后就往index 文件里面记录一个索引 |
| log.retention.hours                     | Kafka 中数据保存的时间，默认7 天                             |
| log.retention.minutes                   | Kafka 中数据保存的时间，分钟级别，默认关闭                   |
| log.retention.ms                        | Kafka 中数据保存的时间，毫秒级别，默认关闭                   |
| log.retention.check.interval.ms         | 检查数据是否保存超时的隔，默认是 5分钟                       |
| log.retention.bytes                     | 默认等于-1，表示无穷大。超过设置的所有日志总大小，删除最早的 segment |
| log.cleanup.policy                      | 默认是 delete，表示所有数据启用删除策略;如果设置值为 compact，表示所有数据启用压缩策略. |
| num.io.threads                          | 默认是 8。负责写磁盘的线程数。整个参数值要占总核数的 50%。   |
| num.replica.fetchers                    | 副本拉取线程数，这个参数占总核数的50%的1/3                   |
| num.network.threads                     | 默认是3。数据传输线程数，这个参数占总核数的50%的 2/3         |
| log.flush.interval.messages             | 强制页缓存刷写到磁盘的条数，默认是 long 的最大值，9223372036854775807。一般不建议修改，交给系统自己管理 |
| log.flush.interval.ms                   | 每隔多久，刷新数据到磁盘，默认是null，一般不建议修改，交给系统自己管理 |

