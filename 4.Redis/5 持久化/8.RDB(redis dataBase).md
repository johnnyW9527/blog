#### 8 redis持久化-rdb

##### 8.1 总体介绍

>Redis是一个基于内存的数据库，它的数据是存放在内存中，内存有个问题就是关闭服务或者断电会丢失。
>
>Redis的数据也支持写到硬盘中，这个过程就叫做持久化。
>
>Redis提供了2种不同形式的持久化方式
>
>* RDB（Redis DataBase）
>* AOP（Append Of File）

##### 8.2 RDB

###### 8.2.1 RDB是什么

> 在指定时间间隔内将内存中的数据集快照写入磁盘，就是Snapshot快照，它回复快照我呢见直接读到内存里

###### 8.2.2 备份是如何执行

> Redis会单独创建（fork）一个子进程进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束后，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何IO操作的，这就是确保了极高的性能，如果需要进行大规模的恢复，且对数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。RDB的缺点是最后一次持久化后的数据可能丢失。

###### 8.2.3 Fork

* Fork的作用是复制一个与当前进程一样的进程，新进程的所有数据（变量、环境变量、程序计数器等）数值都和原进程一致，它是一个全新的进程，并作为原进程的子进程
* 在Linux程序中，fork()会产生一个和父进程完全相同的子进程，但子进程在此后多会exec系统调用，处于效率考虑，linux中引入了“**[写时复制技术]()**”
* 一般情况父进程和子进程会共用一段物理内存，只有进程空间的各段的内容要发生变化时，才会将父进程的内容复制一份给子进程

###### 8.2.4 RDB持久化流程

![](C:\study\mlog\picture\1.png)

###### 8.2.5 指定备份文件的名称

**在redis.conf中，可以修改rdb备份文件的名称，默认为dump.rdb**

```
  417 #
  418 # sanitize-dump-payload no
  419
  420 # The filename where to dump the DB
  421 dbfilename dump.rdb

```



###### 8.2.6 指定备份文件存放的目录

**在redis.conf中，rdb文件的保存的目录是可以修改的，默认为Redis启动命令所在的目录**

```
    438 # The DB will be written inside this directory, with the filename specified
    439 # above using the 'dbfilename' configuration directive.
    440 #
    441 # The Append Only File will also be created inside this directory.
    442 #
    443 # Note that you must specify a directory here, not a file name.
    444 dir ./

```

###### 8.2.7 触发RDB备份

1. **自动备份，需配置备份规则**

 可在redis.conf中配置自动备份的规则，默认规则如下

```
    364 # Unless specified otherwise, by default Redis will save the DB:
    365 #   * After 3600 seconds (an hour) if at least 1 key changed
    366 #   * After 300 seconds (5 minutes) if at least 100 keys changed
    367 #   * After 60 seconds if at least 10000 keys changed
    368 #
    369 # You can set these explicitly by uncommenting the three following lines.
    370 #
    371 # save 3600 1
    372 # save 300 100
    373 # save 60 10000

```

**save用来配置备份的规则**

save的格式： save 秒钟 写操作次数

默认是1分钟内修改了1万次，或5分钟内需修改了10次，或30分钟内修改了1次

示例：设置20秒内有最少有3次key发生变化，则进行备份

save 20 3

2. **手动执行命令备份（save|bgsave）**

有2个命令可以触发备份。

**save**：save时只管保存，其他不管，全部阻塞，手动保存，不建议使用。

**bgsave**：redis会在后台异步进行快照操作，快照同时还可以响应客户端情况

可以通过 lastsave 命令获取最后一次成功生成快照的时间

3. **flushall命令**

执行flushall命令，也会产生dump.rdb文件，但里面是空的，无意义.

###### 8.2.8 redis.conf其他一些配置

**stop-writes-on-bgsave-error**：当磁盘满时，是否关闭**redis**的写操作

>stop-writes-on-bgsave-error用来指定当redis无法写入磁盘的话，是否直接关掉redis的写操作，推荐yes

```
    386 # continue to work as usual even if there are problems with disk,
    387 # permissions, and so forth.
    388 stop-writes-on-bgsave-error yes

```

**rdbcompression**：**rdb**备份是否开启压缩

> 对于存储到磁盘中的rdb快照文件，可以设置是否进行压缩，如果是的话，redis会采用LZF算法进行压缩
>
> 如果你不想消耗CPU来进行压缩的话，可以设置为关闭此功能，推荐yes

```
    392 # If you want to save some CPU in the saving child set it to 'no' but
    393 # the dataset will likely be bigger if you have compressible values or keys.
    394 rdbcompression yes

```

**rdbchecksum**：是否检查**rdb**备份文件的完整性

> 存储快照后，还可以让redis使用CRC64算法来进行数据校验，但是这样做会增加大约10%的性能消耗，如果希望获取最大的性能提升，可以关闭此功能
>
> 推荐yes。

```
    400 #
    401 # RDB files created with checksum disabled have a checksum of zero that will
    402 # tell the loading code to skip the check.
    403 rdbchecksum yes

```

###### 8.2.9 rdb的备份和恢复

1. 先通过config get dir 查询rdb文件的目录
2.  然后将rdb的备份文件 *.rdb 文件拷贝到别的地方
3.  rdb的恢复

* 关闭redis
* 先把备份的文件拷贝到工作目录 cp dump2.rdb dump.rdb
* 启动redis，备份数据直接加载，数据被恢复

###### 8.2.10 优势

* 适合大规模数据恢复
* 对数据完整性和一致性要求不高更适合使用
* 节省磁盘空间
* 恢复速度快

###### 8.2.11 缺点

* Fork的时候，内存中的数据会被克隆一份，大致2倍的膨胀，需要考虑
* 虽然Redis在fork的时候使用了写时拷贝技术，但是如果数据庞大时还是比较消耗性能
* 在备份周期在一定间隔时间做一次备份，所以如果Redis意外down的话，就会丢失最后一次快照后所有修改

###### 8.2.11 停止RDB

动态停止RDB： redis-cli config set save "" #save后给空值，表示禁用保存策略