#### 3. ES查询索引文档的6种方法

##### 3.1 Query String Search (查询串检索)

> 这种方法通过HTTP请求的Query String携带查询参数, 因此得名.适用于临时性的查询请求, 比如在终端检查基础信息:
>
> ```shell
> 检索name中包含Java的文档, 并按价格降序排序: 
> curl -XGET 'http://localhost:9301/book_shop/it_book/_search?q=name:Java&sort=price:desc' 
> ```
>
> 生产环境中很少使用, 因为请求参数都封装到Query String中, 难以构建复杂的查询.
>
> 1. 查询全部商品
>
> ```
> http://172.16.22.133:9301/book_shop/it_book/_search?q=name:Java
> ```
>
> 2. 查询的结果
>
> ```
> {
>     "took": 8,
>     "timed_out": false,
>     "_shards": {
>         "total": 5,
>         "successful": 5,
>         "skipped": 0,
>         "failed": 0
>     },
>     "hits": {
>         "total": 3,
>         "max_score": 1,
>         "hits": [
>             {
>                 "_index": "book_shop",
>                 "_type": "it_book",
>                 "_id": "2",
>                 "_score": 1,
>                 "_source": {
>                     "name": "深入理解Java虚拟机：JVM高级特性与最佳实践",
>                     "author": "周志明",
>                     "category": "编程语言",
>                     "desc": "Java图书领域公认的经典著作",
>                     "price": 79,
>                     "date": "2013-10-01",
>                     "publisher": "机械工业出版社",
>                     "tags": [
>                         "Java",
>                         "虚拟机",
>                         "最佳实践"
>                     ]
>                 }
>             },
>             // 省略另外两条记录
>         ]
>     }
> }
> ```
>
> 3. 查询结果中的各个参数的含义:
>
> * `took`: 此次检索耗费的时间, 单位是毫秒
> * `timed_out`: 是否超出规定的检索时间, 这里没有设置, 后续会讲解此参数
> * `_shards`: 被查询的`index`被分散成多个分片, 所以搜索请求会分发到所有的primary shard(或primary shard对应的某个replica shard)上, 这里显示各个分片是否查询成功的信息
> * `hits`: 命中的文档情况, 有如下参数
>
> ```
> total: 符合条件的文档总数, 即hit(命中)数;
> max_score: Lucene底层对检索到的文档的相关度的评分, 相关度越高, 说明越匹配, score的值也就越高.
> hits: 命中的所有document的详细数据.
> ```

##### 3.2 Query DSL（ES特定语法检索）

> DSL: Domain Specified Language, 特定领域的语言, 一般需要Kibana等工具配合操作.
>
> 这种方式把查询参数构建成JSON格式的数据, 并封装到HTTP请求的Request Body(请求体)中, 可以构建各类复杂的查询语法, 功能要比Query String Search强大很多.
>
> 1. **查询全部商品**
>
> ```
> GET book_shop/it_book/_search
> {
>     "query": { "match_all": {} }
> }
> ```
>
> 2. **查询name中包含Java的商品, 并按price降序排序**
>
> ```
> GET book_shop/it_book/_search
> {
>     "query": {
>         "match": {
>             "name": "Java"
>         }
>     },
>     "sort": [
>         { "price": "desc" }
>     ]
> }
> ```
>
> 3. **分页查询商品 - 每页显示1条, 显示第3页**
>
> ```
> GET book_shop/it_book/_search
> {
>     "query": { "match_all": {} },
>     "from": 2,
>     "size": 1
> }
> ```
>
> 4. **只查询商品的名称和价格**
>
> ```
> GET book_shop/it_book/_search
> {
>     "query": {"match_all": {}},
>     "_source": ["name", "price"]
> }
> ```

##### 3.3 Query Filter（过滤检索）

> 过滤查询, 比如: **查询name中包含Java, 且price不大于80元的商品:**
>
> ```
> GET book_shop/it_book/_search
> {
>     "query": {
>         "bool": {
>           	"must": {
>                 "match": {"name": "Java"}	// name中含有Java
>             },
>             "filter": {
>                 "range": { 
>                     "price": {"lte": 80.0}	// 价格不大于80.0
>                 }
>             }
>         }
>     }
> }
> ```

##### 3.4 Full Text Search（全文检索）

> 1. 查询描述信息desc中包含"Java图书"的文档, 只显示name和desc的值
>
> ```
> GET book_shop/it_book/_search
> {
>     "query": {
>         "match": {"desc": "Java图书"}
>     },
>     "_source": ["name", "desc"]
> }
> ```
>
> 2. 查询结果中有2条数据符合要求
>
> ```
> {
>   "took" : 2,
>   "timed_out" : false,
>   "_shards" : {
>     "total" : 5,
>     "successful" : 5,
>     "skipped" : 0,
>     "failed" : 0
>   },
>   "hits" : {
>     "total" : 2,
>     "max_score" : 0.8630463,
>     "hits" : [
>       {
>         "_index" : "book_shop",
>         "_type" : "it_book",
>         "_id" : "2",
>         "_score" : 0.8630463,
>         "_source" : {
>           "name" : "深入理解Java虚拟机：JVM高级特性与最佳实践",
>           "desc" : "Java图书领域公认的经典著作"			// desc中有"Java"和"图书"
>         }
>       },
>       {
>         "_index" : "book_shop",
>         "_type" : "it_book",
>         "_id" : "1",
>         "_score" : 0.2876821,
>         "_source" : {
>           "name" : "Java编程思想（第4版）",
>           "desc" : "Java学习必读经典,殿堂级著作！"		// desc中有"Java"
>         }
>       }
>     ]
>   }
> }
> ```
>
> 3. **全文检索的过程 —— 对查询结果的说明:**
>
> Elasticsearch会对字段"desc"的内容进行分词, 并建立倒排索引.
>
> 也就是说, 这里会把 "Java图书" 分词为 "Java"、"图"、"书" 3个, 检索时将匹配desc中含有 "Java"、"图"、"书" 中任意一个分词的文档.
>
> —— 对于中文分词, 可以通过IK分词器, 把"Java图书"分解为"Java"、"图书" 2个词, 参考博主的文章:ES XX - Elasticsearch中使用IK中文分词器.

##### 3.5 Phrase Search（短语检索）

> **Full Text Search会对检索文本作分词处理**, 然后从倒排索引中作匹配查询, 如果一个文档的对应field中存在任意一个分解后的词, 那么这个文档就算匹配检索条件.
>
> **Phrase Search不会对检索串进行分词处理**, 只有一个文档的对应field中包含与检索文本完全一致的内容, 该文档才算匹配检索条件, 也才能作为结果返回 —— 可以理解为全文检索场景下的部分精确匹配.
>
> 1. **精确查询desc中包含"Java图书"的文档**
>
> ```
> GET book_shop/it_book/_search
> {
>     "query": {
>         "match_phrase": {
>             "desc": "Java图书"
>         }
>     },
>     "_source": ["name", "desc"]
> }
> ```
>
> 2. 查询结果只有一条数据符合要求
>
> ```
> {
>   "took" : 2,
>   "timed_out" : false,
>   "_shards" : {
>     "total" : 5,
>     "successful" : 5,
>     "skipped" : 0,
>     "failed" : 0
>   },
>   "hits" : {
>     "total" : 1,
>     "max_score" : 0.8630463,
>     "hits" : [
>       {
>         "_index" : "book_shop",
>         "_type" : "it_book",
>         "_id" : "2",
>         "_score" : 0.8630463,
>         "_source" : {
>           "name" : "深入理解Java虚拟机：JVM高级特性与最佳实践",
>           "desc" : "Java图书领域公认的经典著作"		// desc中精确含有"Java图书"
>         }
>       }
>     ]
>   }
> }
> ```

##### 3.6 Highlight Search（高亮检索）

> 1. 分页查询desc中包含"Java图书"的文档, 页大小为1, 显示第1页, 并对搜索条件高亮处理
>
> ```
> GET book_shop/it_book/_search
> {
>     "query": {
>         "match": {"desc": "Java图书"}
>     },
>     "from": 0,
>     "size": 1,
>     "highlight": {
>         "fields": {"desc": {}}
>     },
>     "_source": ["name", "desc"]
> }
> ```
>
> 2. 查询结果
>
> ```
> {
>   "took" : 6,
>   "timed_out" : false,
>   "_shards" : {
>     "total" : 5,
>     "successful" : 5,
>     "skipped" : 0,
>     "failed" : 0
>   },
>   "hits" : {
>     "total" : 2,
>     "max_score" : 0.8630463,
>     "hits" : [
>       {
>         "_index" : "book_shop1",
>         "_type" : "it_book",
>         "_id" : "2",
>         "_score" : 0.8630463,
>         "_source" : {
>           "name" : "深入理解Java虚拟机：JVM高级特性与最佳实践",
>           "desc" : "Java图书领域公认的经典著作"
>         },
>         "highlight" : {		// 高亮显示, 默认添加<em>标签
>           "desc" : [
>             "<em>Java</em><em>图</em><em>书</em>领域公认的经典著作"
>           ]
>         }
>       }
>     ]
>   }
> }
> ```
>
> 